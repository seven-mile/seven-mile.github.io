{"componentChunkName":"component---src-templates-blog-post-md-js","path":"/ufcase/","result":{"data":{"site":{"siteMetadata":{"title":"7mile"}},"post":{"id":"b70de5ea-164e-558c-a777-22fc66f9fd07","excerpt":"","source":{"html":"<p><a href=\"https://github.com/seven-mile/UFCase\">GitHub Repository</a></p>\n<blockquote>\n<p><strong>IMPORTANT</strong></p>\n<p>This tool is experimental and requires full control on your PC. Please DO NOT use it under production environment, especially for the mutation functionalities, which are not properly tested for now.</p>\n</blockquote>\n<p>Windows Servicing Stack is the main infrastructure that integrated with the update of Windows internal components (generally).</p>\n<p>UFCase (Utility Functions Case) provides overall enumeration (and possibly deployment in the future) of multi-level abstractions of these Windows components.</p>\n<p>The article <a href=\"https://techcommunity.microsoft.com/t5/ask-the-performance-team/understanding-component-based-servicing/ba-p/373012\">Understanding Component-Based Servicing\n</a> provides the overview on the Servicing Stack and how it roughly works when an update is installed or removed.</p>\n<h3>Releases</h3>\n<p>I'll publish breaking changes for UFCase in the <a href=\"https://github.com/seven-mile/UFCase/releases\">GitHub releases</a>. And the CI will upload nightly build artifacts of the newest commit. Goto <a href=\"https://github.com/seven-mile/UFCase/actions\">GitHub actions</a>, click the commit you prefer and download <code class=\"language-text\">UFCase_portable.zip</code> from the row <code class=\"language-text\">Artifacts</code>.</p>\n<h3>Glossary</h3>\n<p>All the descriptions below are woven by my own understanding. For your information only.</p>\n<p>Firstly, let's take a look at the underlying mechanisms, which interact with our well-known filesystems and registry.</p>\n<ul>\n<li><strong>Assembly</strong>, is a core concept from .Net but used by Windows Componentization Platform. <a href=\"https://learn.microsoft.com/en-us/dotnet/standard/assembly/\">Assemblies in .NET</a>\n<ul>\n<li>The concept of assembly connects different layers of servicing stack.</li>\n<li>Its <strong>Manifest</strong> uses xml format with schema denoted as <code class=\"language-text\">urn:schemas-microsoft-com:asm.v[1~3]</code>. This article <a href=\"https://learn.microsoft.com/en-us/windows/win32/sbscs/manifest-file-schema\">Manifest File Schema</a> describes the public parts. But most of the schema about windows native components is stripped. There's also a binary representation rather than dumb XML format.</li>\n</ul>\n</li>\n<li><strong>Component</strong>, is a native assembly that compose Windows in the end. Almost everything in Windows can be traced back to a component, including NT Kernel, NTFS driver, servicing stack itself, C runtime framework, system apps and localization resources. The main contents of a real component are a group of files and registry values, with other metadata like\n<ul>\n<li>the source and target concerning installation</li>\n<li>security descriptors signing how they are protected by the system (Windows Resource Protection)</li>\n<li>hash values validating the integrity of the component</li>\n<li>other registration mechanisms like COM interfaces and Win32 window classes</li>\n<li>dependencies</li>\n</ul>\n</li>\n<li><strong>Deployment</strong>, is a special component that defines a bunch of deployable contents by its assembly dependencies.</li>\n<li><strong>WinSxS</strong>, or <strong>Component Store</strong>, is a strong naming, dependency-aware, version-controlled, digitally-signed, corruption-detectable, transactional and hark linking component store organized by assemblies. Popularly speaking, a private package manager for windows itself.\n<ul>\n<li><code class=\"language-text\">SxS</code> expands to <code class=\"language-text\">Side by Side</code>, denoting the components with multiple versions can live within your system side by side.</li>\n<li>Built on the filesystem and registry directly. So compared with databases, its behaves like a turtle.</li>\n<li>The directory <code class=\"language-text\">%WINDIR%\\WinSxS</code></li>\n<li>The registry hive <code class=\"language-text\">HKEY_LOCAL_MACHINE\\COMPONENTS</code> from <code class=\"language-text\">%WINDIR%\\System32\\config</code></li>\n<li>The registry key <code class=\"language-text\">HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\SideBySide</code></li>\n</ul>\n</li>\n<li><strong>Windows Componentization Platform</strong>, a.k.a. <code class=\"language-text\">wcp.dll</code> from servicing stack, is a native implementation of assembly store, or technically \"Isolation Interface\". Correspondingly, .Net Framework used to have its own isolation implementation. Many DLLs <em>probably</em> had a version that implemented isolation, includes <code class=\"language-text\">sxs.dll</code>, <code class=\"language-text\">isowin32.dll</code>, <code class=\"language-text\">isoman.dll</code>, <code class=\"language-text\">clr.dll</code>, <code class=\"language-text\">coreclr.dll</code>, and even <code class=\"language-text\">ntdll.dll</code>.</li>\n</ul>\n<hr>\n<p>Now let's change our point of view to the upper layers. After the <strong>Updates (Windows Update)</strong> are downloaded into the <code class=\"language-text\">SoftwareDistribution</code>, what information do they take and which contents do they ship?</p>\n<ul>\n<li><strong>Update (Windows Update)</strong>, also known as <code class=\"language-text\">*.msu</code>. The <code class=\"language-text\">.msu</code> file archives some other <code class=\"language-text\">.cab</code> recursively - some contain metadata (<code class=\"language-text\">CompDB</code> or <code class=\"language-text\">OfflineSyncPackage</code>), some are the payloads, which are in fact called \"Package\".</li>\n<li><strong>Package (CBS)</strong>, is a high-level assembly. They can be queried using <code class=\"language-text\">Dism /Online /Get-Packages</code>. The package has many available formats. Some well known technologies like msdelta a delta package format are used on it. But again and again... all of them have two parts: manifest and payload. The manifest of packages ends with <code class=\"language-text\">.mum</code>, describing:\n<ul>\n<li>which updates (CBS) are included, this is the payload descriptor</li>\n<li>which packages are its parents, some pack has lang packs as their children</li>\n</ul>\n</li>\n<li><strong>Capability (CBS)</strong>, also known as <strong>Feature on Demand</strong>. They canbe queried with <code class=\"language-text\">Dism /Online /Get-Capabilities</code>. Capabilities are generally a bunch of packages. They are not present in your disk at the first time, and can be downloaded from Windows Update Server.</li>\n<li><strong>Update (CBS)</strong>, is a logical concept that only exists in the manifest of packages. It reference to an assembly, wrappered by\n<ul>\n<li>a <code class=\"language-text\">component</code> element, which is an ordinary WinSxS assembly component</li>\n<li>a <code class=\"language-text\">package</code> element, which refer to another package</li>\n<li>a <code class=\"language-text\">driver</code> element, which is a driver</li>\n</ul>\n</li>\n<li><strong>Feature (CBS)</strong>, is actually should be called <strong>Optional Feature</strong>, differing from <strong>Feature on Demand</strong>. Features are the updates of the special package <code class=\"language-text\">Microsoft-Windows-Foundation-Package</code>, and can be queried by <code class=\"language-text\">Dism /Online /Get-Features</code>. These features are staged in WinSxS but not usable directly. If you need it you can enable it <em>without network connection</em>.</li>\n</ul>"},"frontmatter":{"title":"UFCase README","date":"September 13, 2023","description":"Deep dive into \"Servicing Stack\""}},"previous":{"slug":"/msix-dynamic-dependency/","frontmatter":{"title":"MSIX Dynamic Dependency"}},"next":{"slug":"/gatsby-typst-support/","frontmatter":{"title":"Write modern weblog with typst.ts"}}},"pageContext":{"id":"b70de5ea-164e-558c-a777-22fc66f9fd07","previousPostId":"7c10c63f-467f-5675-973d-62628b242c25","nextPostId":"a6bd48ba-dc97-5510-9e18-7c0fb100f26c"}},"staticQueryHashes":["2841359383","3660991324","4183435130"],"slicesMap":{}}